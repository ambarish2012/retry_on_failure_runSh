resources:
  # Create a key-value pair integration to securely specify the API token
  # http://docs.shippable.com/platform/integration/key-value/
  - name:           api_token
    type:           integration
    integration:    API_TOKEN_INTEGRATION
    
jobs:
  - name: retriable_job
    type: runSh
    allowPublicAccess: true
    steps:
      - IN: api_token
      - TASK:
          runtime:
            options:
              env:
                - max_retries: 3
          script:
            # simulate job failure
            - cat phantom_file.sh
    on_success:
      script:
        #reset failure counter
        - shipctl post_resource_state $JOB_NAME failure_counter 0
    on_failure:
      script:
        - counterVal=$(shipctl get_resource_state "failure_counter") 
        - |
          if [ $counterVal -eq $max_retries ]
          then
              # reset counter and do nothing
              shipctl post_resource_state $JOB_NAME failure_counter 0
          else
              # increment failure counter
              let "counterVal++"
              echo "Retring on failure, counter: "$counterVal
              shipctl post_resource_state $JOB_NAME failure_counter counterVal
              # retrigger job via API
              # replace 62911 with the jobid of your runSh job. Click on the runSh job and scroll to the bottom of the page.
              sleep 30
              'curl -X POST -H "Authorization: apiToken $API_TOKEN" -H "Content-Type: application/json" -H "Accept: application/json" "https://api.shippable.com/resources/62911/triggerNewBuildRequest"'
          fi
